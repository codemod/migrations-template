name: PR-based Auto-publish

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'recipes/**'
  issue_comment:
    types: [created]

jobs:
  detect-changes:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    outputs:
      codemods: ${{ steps.detect.outputs.codemods }}
      has-changes: ${{ steps.detect.outputs.has-changes }}
      publish-commands: ${{ steps.detect.outputs.publish-commands }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Need full history for diff
    
    - name: Detect codemod changes
      id: detect
      run: |
        # Get the base and head commits
        BASE_SHA="${{ github.event.pull_request.base.sha }}"
        HEAD_SHA="${{ github.event.pull_request.head.sha }}"
        
        echo "Comparing $BASE_SHA..$HEAD_SHA"
        
        # Find changed codemod directories
        CHANGED_CODEMODS=$(git diff --name-only $BASE_SHA..$HEAD_SHA | grep '^recipes/' | cut -d'/' -f1-2 | sort -u | tr '\n' ' ')
        
        if [ -z "$CHANGED_CODEMODS" ]; then
          echo "has-changes=false" >> $GITHUB_OUTPUT
          echo "No codemod changes detected"
          exit 0
        fi
        
        echo "has-changes=true" >> $GITHUB_OUTPUT
        echo "codemods=$CHANGED_CODEMODS" >> $GITHUB_OUTPUT
        
        echo "Changed codemods: $CHANGED_CODEMODS"
        
        # Generate publish commands for each changed codemod
        PUBLISH_COMMANDS=""
        for codemod_dir in $CHANGED_CODEMODS; do
          if [ -f "$codemod_dir/codemod.yaml" ]; then
            # Extract name and version from codemod.yaml
            NAME=$(grep '^name:' "$codemod_dir/codemod.yaml" | sed 's/name: *//' | tr -d ' ')
            VERSION=$(grep '^version:' "$codemod_dir/codemod.yaml" | sed 's/version: *//' | tr -d ' ')
            
            if [ -n "$NAME" ] && [ -n "$VERSION" ]; then
              # Use codemod publish command instead of git tag
              COMMAND="npx codemod@latest publish $codemod_dir"
              PUBLISH_COMMANDS="${PUBLISH_COMMANDS}${COMMAND}\n"
            fi
          fi
        done
        
        # Store commands as job output
        echo "publish-commands=$PUBLISH_COMMANDS" >> $GITHUB_OUTPUT

  comment-on-pr:
    if: github.event_name == 'pull_request' && needs.detect-changes.outputs.has-changes == 'true'
    needs: detect-changes
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Need full history for diff
    
    - name: Setup pnpm
      uses: pnpm/action-setup@v4
      with:
        version: latest
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'pnpm'
    
    - name: Install dependencies
      run: pnpm install
    
    - name: Comment on PR
      uses: actions/github-script@v7
      with:
        script: |
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
          });
          
          // Check if we already commented
          const existingComment = comments.find(comment => 
            comment.user.type === 'Bot' && 
            comment.body.includes('Show a thumbs up to this comment')
          );
          
          if (existingComment) {
            console.log('Comment already exists, skipping...');
            return;
          }
          
          const codemods = '${{ needs.detect-changes.outputs.codemods }}'.split(' ').filter(Boolean);
          const publishCommands = '${{ needs.detect-changes.outputs.publish-commands }}';
          
          const commentBody = `## üöÄ Ready to Publish Codemods
          
          **Changed codemods:** ${codemods.map(c => `\`${c}\``).join(', ')}
          
          Show a thumbs up üëç to this comment and I'll run the below commands to auto-publish the codemod(s) to the registry:
          
          \`\`\`bash
          ${publishCommands}
          \`\`\`
          
          **Note:** Only reactions from repository maintainers will trigger the publishing workflow.
          
          ---
          *This comment was automatically generated by the PR-based auto-publish workflow.*`;
          
          await github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
            body: commentBody
          });

  handle-reaction:
    if: github.event_name == 'issue_comment'
    runs-on: ubuntu-latest
    
    steps:
    - name: Check if comment is from our bot
      id: check-comment
      run: |
        COMMENT_BODY="${{ github.event.comment.body }}"
        if echo "$COMMENT_BODY" | grep -q "Show a thumbs up to this comment"; then
          echo "is-bot-comment=true" >> $GITHUB_OUTPUT
        else
          echo "is-bot-comment=false" >> $GITHUB_OUTPUT
        fi
    
    - name: Check for thumbs up reaction
      if: steps.check-comment.outputs.is-bot-comment == 'true'
      id: check-reaction
      uses: actions/github-script@v7
      with:
        script: |
          const { data: reactions } = await github.rest.reactions.listForIssueComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            comment_id: context.event.comment.id,
          });
          
          // Get repository collaborators to check if reactor is a maintainer
          const { data: collaborators } = await github.rest.repos.listCollaborators({
            owner: context.repo.owner,
            repo: context.repo.repo,
          });
          
          const maintainers = collaborators
            .filter(collab => collab.permissions.admin || collab.permissions.maintain)
            .map(collab => collab.login);
          
          const thumbsUpReaction = reactions.find(reaction => 
            reaction.content === '+1' && maintainers.includes(reaction.user.login)
          );
          
          if (thumbsUpReaction) {
            console.log('Maintainer approved with thumbs up!');
            core.setOutput('approved', 'true');
            core.setOutput('approver', thumbsUpReaction.user.login);
          } else {
            console.log('No maintainer approval found');
            core.setOutput('approved', 'false');
          }
    
    - name: Checkout code
      if: steps.check-reaction.outputs.approved == 'true'
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup pnpm
      if: steps.check-reaction.outputs.approved == 'true'
      uses: pnpm/action-setup@v4
      with:
        version: latest
    
    - name: Setup Node.js
      if: steps.check-reaction.outputs.approved == 'true'
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'pnpm'
    
    - name: Install dependencies
      if: steps.check-reaction.outputs.approved == 'true'
      run: pnpm install
    
    - name: Check API key configuration
      if: steps.check-reaction.outputs.approved == 'true'
      run: |
        if [ -z "${{ secrets.CODEMOD_API_KEY }}" ]; then
          echo "‚ùå CODEMOD_API_KEY secret is not configured"
          echo "Please set up your API key in GitHub secrets"
          exit 1
        fi
        echo "‚úÖ API key is configured"
    
    - name: Auto-bump versions if needed
      if: steps.check-reaction.outputs.approved == 'true'
      run: |
        COMMENT_BODY="${{ github.event.comment.body }}"
        
        # Extract codemod directories from the comment
        CODEMODS=$(echo "$COMMENT_BODY" | grep -o '`recipes/[^`]*`' | sed 's/`//g')
        
        for codemod_dir in $CODEMODS; do
          if [ -f "$codemod_dir/codemod.yaml" ]; then
            echo "Checking $codemod_dir for version conflicts..."
            
            # Try to publish first to see if version exists
            set +e
            npx codemod@latest publish "$codemod_dir" --dry-run 2>&1 | grep -q "version.*already exists"
            VERSION_EXISTS=$?
            set -e
            
            if [ $VERSION_EXISTS -eq 0 ]; then
              echo "Version conflict detected in $codemod_dir, auto-bumping..."
              
              # Extract current version
              CURRENT_VERSION=$(grep '^version:' "$codemod_dir/codemod.yaml" | sed 's/version: *//' | tr -d ' ')
              
              # Bump patch version
              NEW_VERSION=$(echo "$CURRENT_VERSION" | awk -F. '{$NF = $NF + 1;} 1' | sed 's/ /./g')
              
              # Update codemod.yaml
              sed -i.bak "s/^version: .*/version: $NEW_VERSION/" "$codemod_dir/codemod.yaml"
              
              echo "‚úÖ Bumped version from $CURRENT_VERSION to $NEW_VERSION in $codemod_dir"
            else
              echo "‚úÖ No version conflict in $codemod_dir"
            fi
          fi
        done
      env:
        CODEMOD_API_KEY: ${{ secrets.CODEMOD_API_KEY }}
        CODEMOD_REGISTRY_SCOPE: ${{ vars.CODEMOD_REGISTRY_SCOPE || 'codemod' }}
        CODEMOD_REGISTRY_URL: ${{ vars.CODEMOD_REGISTRY_URL || 'https://registry.codemod.com' }}
    
    - name: Extract and execute publish commands
      if: steps.check-reaction.outputs.approved == 'true'
      id: publish
      run: |
        COMMENT_BODY="${{ github.event.comment.body }}"
        
        # Extract commands from the comment
        echo "Extracting commands from comment..."
        
        # Get the bash code block content
        COMMANDS=$(echo "$COMMENT_BODY" | sed -n '/```bash/,/```/p' | sed '1d;$d')
        
        echo "Executing commands:"
        echo "$COMMANDS"
        
        # Execute commands with error handling
        set +e  # Don't exit on error
        echo "$COMMANDS" | bash
        PUBLISH_EXIT_CODE=$?
        set -e  # Re-enable exit on error
        
        if [ $PUBLISH_EXIT_CODE -eq 0 ]; then
          echo "‚úÖ Publishing commands executed successfully!"
          echo "success=true" >> $GITHUB_OUTPUT
        else
          echo "‚ùå Publishing failed with exit code: $PUBLISH_EXIT_CODE"
          echo "success=false" >> $GITHUB_OUTPUT
          echo "exit_code=$PUBLISH_EXIT_CODE" >> $GITHUB_OUTPUT
        fi
      env:
        CODEMOD_API_KEY: ${{ secrets.CODEMOD_API_KEY }}
        CODEMOD_REGISTRY_SCOPE: ${{ vars.CODEMOD_REGISTRY_SCOPE || 'codemod' }}
        CODEMOD_REGISTRY_URL: ${{ vars.CODEMOD_REGISTRY_URL || 'https://registry.codemod.com' }}
    
    - name: Update comment with result
      if: steps.check-reaction.outputs.approved == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          const approver = '${{ steps.check-reaction.outputs.approver }}';
          const success = '${{ steps.publish.outputs.success }}' === 'true';
          const exitCode = '${{ steps.publish.outputs.exit_code }}';
          
          let commentBody;
          
          if (success) {
            commentBody = `## ‚úÖ Published Successfully!
            
            **Approved by:** @${approver}
            **Published at:** ${new Date().toISOString()}
            
            The codemods have been successfully published to the registry.
            
            ---
            *This comment was automatically updated by the PR-based auto-publish workflow.*`;
          } else {
            commentBody = `## ‚ùå Publishing Failed
            
            **Approved by:** @${approver}
            **Failed at:** ${new Date().toISOString()}
            **Exit code:** ${exitCode}
            
            The publishing process encountered an error. Common issues:
            
            - **Invalid API key**: Check your \`CODEMOD_API_KEY\` secret
            - **Version conflict**: The codemod version may already exist - try bumping the version in \`codemod.yaml\`
            - **Network issues**: Registry may be temporarily unavailable
            - **Invalid codemod**: Check that your codemod structure is correct
            
            **To retry:**
            1. Fix the issue (e.g., bump version in \`codemod.yaml\`)
            2. Push new changes to this PR
            3. Give another thumbs up üëç to this comment
            
            ---
            *This comment was automatically updated by the PR-based auto-publish workflow.*`;
          }
          
          await github.rest.issues.updateComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            comment_id: context.event.comment.id,
            body: commentBody
          });
